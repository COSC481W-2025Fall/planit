import dotenv from 'dotenv';
dotenv.config(); 

import passport from 'passport';
import { Strategy as GoogleStrategy } from 'passport-google-oauth20';
import {sql} from './config/db.js';
import {VITE_BACKEND_URL, LOCAL_BACKEND_URL} from "../Constants.js";

passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  callbackURL: (process.env.ENVIRONMENT === "production" ? VITE_BACKEND_URL : LOCAL_BACKEND_URL) + "/auth/google/callback",
  passReqToCallback: true,
},
async function(request, accessToken, refreshToken, profile, done) {
   try
   {
    const name = profile.displayName;

    const nameParts = name.split(" ");
    const firstName = nameParts[0];
    const lastName = nameParts.slice(1).join(" ") || "";
    const email = profile.emails[0].value;
    const photo = "data:image/jpeg;base64,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";
    // I need to check if this user already exists in the database
    // if not, I need to create a new user in the database
    // if they do exist, I need to return the user from the database
    const existingUser = await sql `
    SELECT * 
    FROM users 
    WHERE email = ${email}
    `;

    let user ;

    // if the length of the result we just queried is 0 , then we know this must be a  new user
    if(existingUser.length === 0)
    {
      const newUser = await sql `
        INSERT INTO users 
        (first_name,last_name,email,photo) 
        VALUES (${firstName},${lastName},${email},${photo}) 
        RETURNING *
      `;
      user = newUser[0];
    } 
    else 
    {
      user = existingUser[0];
    }
    

    return done(null, user);
   } catch(err)
   {
    return done(err,null);
   }
}));

export function isLoggedIn(req, res, next) {
  if(!req.user) {
    return res.status(401).json({ loggedIn: false });
  }
  next();
}

passport.serializeUser(function(user, done) {
  done(null, user);
});

passport.deserializeUser(function(user, done) {
  done(null, user);
});